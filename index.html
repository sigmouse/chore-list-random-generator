<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Chore Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        #result {
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
        }
        #rerollButton {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Random Chore Generator</h1>
    <button id="generateButton" onclick="generateRandomChore()">Get Random Chore</button>
    <button id="rerollButton" onclick="rerollChore()" style="display:none;">Re-roll</button>
    <div id="result"></div>

    <script>
        const SHEET_ID = '1-T95_BJRz3Vm2ffio4-ib0F5JKjlMz-VsPRxau0nuo4'; // Replace with your actual Google Sheet ID
        const API_KEY = 'AIzaSyDbuG7m8dq7FhHzMBG4M48Z6mC9TSE9wiI'; // Replace with your actual API key
        const CHORE_RANGE = 'Chores!A:B'; // Chores data
        const NUMBERS_RANGE = 'Numbers!A1:Z1'; // Array of available numbers

        let availableNumbers = []; // To hold the fetched numbers
        let lastRandomNumber = null; // To keep track of the last generated number

        // Fetch the available numbers from the Numbers sheet
        async function fetchAvailableNumbers() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${NUMBERS_RANGE}?key=${API_KEY}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                availableNumbers = data.values[0].map(Number); // Convert to array of numbers
            } catch (error) {
                console.error('Error fetching available numbers:', error);
                document.getElementById('result').innerText = 'Failed to load available numbers.';
            }
        }

        // Update the Numbers sheet with the modified array
        async function updateAvailableNumbers() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${NUMBERS_RANGE}?valueInputOption=RAW&key=${API_KEY}`;
            const body = {
                range: NUMBERS_RANGE,
                majorDimension: 'ROWS',
                values: [availableNumbers],
            };

            try {
                await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
            } catch (error) {
                console.error('Error updating available numbers:', error);
            }
        }

        // Fetch a chore from the Google Sheet based on a random number
        async function fetchChore(randomNumber) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${CHORE_RANGE}?key=${API_KEY}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                const rows = data.values;

                // Find the chore with the matching ID
                const chore = rows.find(row => parseInt(row[0]) === randomNumber);
                if (chore) {
                    document.getElementById('result').innerText = `Your chore is: ${chore[1]}`;
                    document.getElementById('rerollButton').style.display = 'inline-block'; // Show the "Re-roll" button

                    // Remove the selected number from the list
                    availableNumbers = availableNumbers.filter(num => num !== randomNumber);
                    await updateAvailableNumbers(); // Update the sheet
                } else {
                    document.getElementById('result').innerText = `No chore found for ID: ${randomNumber}`;
                }
            } catch (error) {
                console.error('Error fetching chore:', error);
                document.getElementById('result').innerText = 'Failed to load chore.';
            }
        }

        // Generate a random number and fetch the corresponding chore
        async function generateRandomChore() {
            if (availableNumbers.length === 0) {
                document.getElementById('result').innerText = 'No more chores available!';
                document.getElementById('rerollButton').style.display = 'none';
                return;
            }

            const randomIndex = Math.floor(Math.random() * availableNumbers.length);
            lastRandomNumber = availableNumbers[randomIndex];
            await fetchChore(lastRandomNumber);
        }

        // Re-roll to fetch a new random chore
        async function rerollChore() {
            if (availableNumbers.length <= 1) {
                document.getElementById('result').innerText = 'No more chores available!';
                document.getElementById('rerollButton').style.display = 'none';
                return;
            }

            let newRandomNumber;
            do {
                const randomIndex = Math.floor(Math.random() * availableNumbers.length);
                newRandomNumber = availableNumbers[randomIndex];
            } while (newRandomNumber === lastRandomNumber); // Ensure the new number is different

            lastRandomNumber = newRandomNumber; // Update the last random number
            await fetchChore(lastRandomNumber);
        }

        // Initialize by loading available numbers
        (async () => {
            await fetchAvailableNumbers();
        })();
    </script>
</body>
</html>
